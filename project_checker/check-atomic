#!/usr/bin/env bash

# Run an individual check fro the CLI, safe to be `source`d so as to persist the variables.

# Source the util library relative to this script's location (zsh-compatible)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-${(%):-%x}}")" && pwd)"
source "$SCRIPT_DIR/../feedback_functions.lib"
source "$SCRIPT_DIR/../audit_reporting.lib"
PLATFORM_CLI=${PLATFORM_CLI:-platform}
# When running CLI, avoid any interactive prompts.
export PLATFORMSH_CLI_NO_INTERACTION="1"

source "$SCRIPT_DIR/checks/$1" || ( log_error "Invalid check. could not source $1" && exit 1 )

# `main` wrapper to everything make early exit safe. running `source` can exit fatally accidentally.
main() {

  log_notice "Running check: \033[97;40m$(basename $1)\033[0m "
  log_notice "$CHECK_DESCRIPTION"
  # if not empty, log about the RETURN var
  if [[ -n "$CHECK_RETURN_VARNAME" ]]; then
    log_notice "This check will set the value of '$CHECK_RETURN_VARNAME' if sourced"
  fi
  # if not being source'd show a warning
  if [ -n "${BASH_SOURCE[0]}" ] && [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    log_warning "Variables will not be set unless this script is source'd, not called"
  fi

  check_required_parameters_are_set || return $?

  # If the check explicitly published what its check process was, show that.
  log_notice "$literal_check_command"

  # This evaluation of the `check` command needs to capture the
  # STDOUT, STERR and return code, and log them each
  # into the audit_reporting_set_check
  set +e
  TMPLOG=$(mktemp)
  OUTPUT=$( check 2>"$TMPLOG")
  STATUS_CODE=$?
  LOG=$(cat "$TMPLOG")
  rm "$TMPLOG"
  set -e

  log_info "$LOG"

  STATUS_TEXT=$(audit_status_code_to_text $STATUS_CODE)

  # audit_report_result "$CHECK_ID" "$STATUS_TEXT" "$OUTPUT" "$LOG"
  echo "$OUTPUT"
  if [[ -n "$CHECK_RETURN_VARNAME" && -n "$OUTPUT" ]]; then
    export $CHECK_RETURN_VARNAME="$OUTPUT"
    # Use eval for zsh/bash compatibility instead of ${!var}
    log_notice "export $CHECK_RETURN_VARNAME='$(eval echo \$$CHECK_RETURN_VARNAME)' "
  fi
}
main "$@"
