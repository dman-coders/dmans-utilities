#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/jellyfin-utils.lib"

# FindItemCollections - Find all collections containing a given item
#
# Usage: FindItemCollections ITEM_ID
#
# Returns: JSON array of collections containing the item (for diagnostics)

ITEM_ID="$1"

jellyfin_require_args 1 $# "Usage: $0 ITEM_ID" || exit 1

log_info "Finding collections for item: $ITEM_ID"

# Get all collections
COLLECTIONS=$(./ListCollections)

if [ -z "$COLLECTIONS" ]; then
    log_error "Could not retrieve collections"
    exit 1
fi

# For each collection, check if item is a member
echo "$COLLECTIONS" | jq -r '.[] | .Id' | while read COLL_ID; do
    MATCH=$(./Items --parent-id "$COLL_ID" --fields Id 2>/dev/null | \
            jq --arg itemid "$ITEM_ID" 'map(select(.Id == $itemid)) | length')

    if [ "$MATCH" == "1" ]; then
        echo "$COLLECTIONS" | jq --arg cid "$COLL_ID" '.[] | select(.Id == $cid)'
    fi
done | jq -s '.'
