#!/usr/bin/env bash

# AddItemToCollection - Add item(s) to a Jellyfin collection
#
# Usage: AddItemToCollection COLLECTION_ID ITEM_ID [ITEM_ID ...]
#
# Examples:
#   AddItemToCollection "5f408f9d50b7ddd6da73b69228fbf3c6" "item-id-1"
#   AddItemToCollection "5f408f9d50b7ddd6da73b69228fbf3c6" "item-id-1" "item-id-2" "item-id-3"
#
# Returns: JSON response from API

COLLECTION_ID="$1"
shift

if [ -z "$COLLECTION_ID" ] || [ -z "$1" ]; then
    echo "Usage: $0 COLLECTION_ID ITEM_ID [ITEM_ID ...]" >&2
    echo "  COLLECTION_ID: Jellyfin collection/BoxSet ID" >&2
    echo "  ITEM_ID: One or more item IDs to add" >&2
    exit 1
fi

# Join item IDs with comma
ITEM_IDS=$(IFS=,; echo "$*")

echo "Adding items to collection: $COLLECTION_ID" >&2
echo "  Items: $ITEM_IDS" >&2

# Make request
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
    -H "Authorization: MediaBrowser Token=\"$JELLYFIN_API_KEY\"" \
    "http://$JELLYFIN_HOST:$JELLYFIN_PORT/Collections/$COLLECTION_ID/Items?Ids=$ITEM_IDS")

# Extract status and body (macOS compatible)
STATUS=$(echo "$RESPONSE" | tail -1)
BODY=$(echo "$RESPONSE" | sed '$d')

if [ "$STATUS" = "204" ]; then
    echo "" >&2
    echo "Items added successfully!" >&2
    exit 0
elif [ "$STATUS" = "200" ]; then
    echo "" >&2
    echo "Items added successfully!" >&2
    if [ -n "$BODY" ]; then
        echo "$BODY" | jq '.'
    fi
    exit 0
else
    echo "" >&2
    echo "Error (HTTP $STATUS): $BODY" >&2
    exit 1
fi
