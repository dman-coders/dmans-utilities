#!/usr/bin/env bash

# jellyfin-update-tags - Update tags on a Jellyfin item
#
# Usage:
#   jellyfin-update-tags ITEM_ID "tag1" "tag2" "tag3"
#   jellyfin-update-tags ITEM_ID --append "tag1" "tag2"
#   jellyfin-update-tags ITEM_ID --replace "tag1" "tag2"
#   jellyfin-update-tags ITEM_ID --clear
#
# Modes:
#   Default (--replace): Replace all tags with new ones
#   --append: Add new tags to existing ones
#   --clear: Remove all tags
#
# Output: Updated item JSON

ITEM_ID="$1"
shift

if [ -z "$ITEM_ID" ]; then
    echo "Usage: $0 ITEM_ID [--append|--replace|--clear] [tags...]" >&2
    echo "  ITEM_ID: Jellyfin item ID" >&2
    echo "  Default mode: Replace all tags (use --replace explicitly to be clear)" >&2
    echo "  --append: Add tags to existing ones" >&2
    echo "  --clear: Remove all tags" >&2
    exit 1
fi

MODE="replace"
TAGS_JSON="[]"

# Parse mode and tags
if [ "$1" = "--append" ]; then
    MODE="append"
    shift

    # Fetch current tags
    CURRENT=$(curl -s -H "Authorization: MediaBrowser Token=\"$JELLYFIN_API_KEY\"" \
        "http://$JELLYFIN_HOST:$JELLYFIN_PORT/Items/$ITEM_ID?Fields=Tags" 2>/dev/null)

    EXISTING_TAGS=$(echo "$CURRENT" | jq '.Tags // []' 2>/dev/null)

    # Merge new tags with existing
    NEW_TAGS=()
    while [ $# -gt 0 ]; do
        NEW_TAGS+=("$1")
        shift
    done

    TAGS_JSON=$(echo "$EXISTING_TAGS" | jq ". + $(printf '%s\n' "${NEW_TAGS[@]}" | jq -R . | jq -s .)")

elif [ "$1" = "--clear" ]; then
    MODE="clear"
    TAGS_JSON="[]"
    shift

elif [ "$1" = "--replace" ]; then
    MODE="replace"
    shift
    NEW_TAGS=()
    while [ $# -gt 0 ]; do
        NEW_TAGS+=("$1")
        shift
    done
    TAGS_JSON=$(printf '%s\n' "${NEW_TAGS[@]}" | jq -R . | jq -s .)

else
    # Default: replace mode
    NEW_TAGS=()
    while [ $# -gt 0 ]; do
        NEW_TAGS+=("$1")
        shift
    done
    TAGS_JSON=$(printf '%s\n' "${NEW_TAGS[@]}" | jq -R . | jq -s .)
fi

if [ -z "$TAGS_JSON" ] || [ "$TAGS_JSON" = "null" ]; then
    TAGS_JSON="[]"
fi

# Build JSON payload
PAYLOAD=$(jq -n --argjson tags "$TAGS_JSON" '{Tags: $tags}')

echo "Updating item: $ITEM_ID (mode: $MODE)" >&2
echo "Tags: $(echo "$TAGS_JSON" | jq '.')" >&2

# Update the item
RESPONSE=$(curl -s -X POST \
    -H "Authorization: MediaBrowser Token=\"$JELLYFIN_API_KEY\"" \
    -H "Content-Type: application/json" \
    -d "$PAYLOAD" \
    "http://$JELLYFIN_HOST:$JELLYFIN_PORT/Items/$ITEM_ID")

# Check if update was successful
if echo "$RESPONSE" | jq -e . >/dev/null 2>&1; then
    echo "" >&2
    echo "Tags updated successfully!" >&2
    echo "$RESPONSE" | jq '.Tags'
else
    echo "Error updating tags: $RESPONSE" >&2
    exit 1
fi
