#!/usr/bin/env bash

# jellyfin-get-item-by-path - Retrieve item from Jellyfin by filesystem path
#
# Usage: jellyfin-get-item-by-path "/path/to/file.mp4"
#
# Outputs JSON with item details including:
#   - Id, Name, Path
#   - Tags, Genres
#   - Type (Video, Photo, etc.)
#   - Container, RunTimeTicks, etc.
JELLYFIN_ROOT_DATA_FOLDER="${JELLYFIN_ROOT_DATA_FOLDER:-/mnt/raid1/X/HOWTO}"

FILE_PATH="$1"

# if filepath is not root-absolute, prepend the root data folder
if [[ "$FILE_PATH" != /* ]]; then
    FILE_PATH="$JELLYFIN_ROOT_DATA_FOLDER/$FILE_PATH"
fi

if [ -z "$FILE_PATH" ]; then
    echo "Usage: $0 /path/to/file" >&2
    echo "  FILE_PATH: Full filesystem path to the item" >&2
    exit 1
fi

# Normalize the path (remove trailing slashes, resolve symlinks if needed)
FILE_PATH=$(cd "$(dirname "$FILE_PATH")" 2>/dev/null && echo "$PWD/$(basename "$FILE_PATH")" || echo "$FILE_PATH")

# Fetch all items with Path field
# We need to search through all items to find one matching this path
# Jellyfin API doesn't support direct path-based search, so we fetch and filter
RESPONSE=$(curl -s -H "Authorization: MediaBrowser Token=\"$JELLYFIN_API_KEY\"" \
    "http://$JELLYFIN_HOST:$JELLYFIN_PORT/Items?Recursive=true&IncludeItemTypes=Video,Photo&Fields=Path,Name,Id,Tags,Genres,Type,Container,RunTimeTicks,PremiereDate,ImageTags&Limit=1000")

# Filter results to find exact path match
ITEM=$(echo "$RESPONSE" | jq --arg path "$FILE_PATH" '.Items[] | select(.Path == $path)' 2>/dev/null)

if [ -z "$ITEM" ] || [ "$ITEM" = "null" ]; then
    echo "Error: Item not found at path: $FILE_PATH" >&2

    # Debug: show what paths exist (first few)
    echo "Available paths (sample):" >&2
    echo "$RESPONSE" | jq -r '.Items[0:3] | .[] | .Path' 2>/dev/null | sed 's/^/  /' >&2

    exit 1
fi

# Output the item as JSON
echo "$ITEM" | jq '.'
