#!/usr/bin/env bash

# Usage: CreateCollection "Collection Name" [ItemIds]
# Examples:
#   CreateCollection "Test Collection"
#   CreateCollection "New Collection" "item-id-1,item-id-2"
#
# Note: Jellyfin Collections (BoxSets) do not support hierarchical nesting.
# All collections are created at the same level. Use naming conventions
# for organization (e.g., "Location-Inside-Bedroom" or "Location: Inside: Bedroom")

NAME="$1"
ITEM_IDS="$2"

if [ -z "$NAME" ]; then
    echo "Usage: $0 \"Collection Name\" [ItemIds]" >&2
    echo "  ItemIds: Optional comma-separated list of item IDs to add" >&2
    exit 1
fi

# URL encode the name
ENCODED_NAME=$(printf %s "$NAME" | jq -sRr @uri)

# Build URL with query parameters
URL="http://$JELLYFIN_HOST:$JELLYFIN_PORT/Collections?Name=$ENCODED_NAME&UserId=$JELLYFIN_USERID"

# Add Ids if provided
if [ -n "$ITEM_IDS" ]; then
    URL="${URL}&Ids=$ITEM_IDS"
    echo "Adding items: $ITEM_IDS" >&2
fi

echo "Creating collection: $NAME" >&2

# Create the collection
RESPONSE=$(curl -s -X POST \
    -H "Authorization: MediaBrowser Token=\"$JELLYFIN_API_KEY\"" \
    "$URL")

# Check if response is valid JSON
if echo "$RESPONSE" | jq -e . >/dev/null 2>&1; then
    COLLECTION_ID=$(echo "$RESPONSE" | jq -r '.Id')
    echo "" >&2
    echo "Collection created successfully!" >&2
    echo "  ID: $COLLECTION_ID" >&2
    echo "" >&2
    echo "$RESPONSE" | jq '.'
else
    echo "Error: $RESPONSE" >&2
    exit 1
fi
