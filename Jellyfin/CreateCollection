#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/jellyfin-utils.lib"

# CreateCollection - Create a new Jellyfin collection
#
# Usage: CreateCollection "Collection Name" [ItemIds]
#
# Examples:
#   CreateCollection "My Collection"
#   CreateCollection "Best Videos" "id1,id2,id3"

NAME="$1"
ITEM_IDS="$2"

jellyfin_require_args 1 $# "Usage: $0 \"Collection Name\" [ItemIds]" || exit 1

# URL encode the name
ENCODED_NAME=$(printf %s "$NAME" | jq -sRr @uri)

URL_PARAMS="?Name=$ENCODED_NAME&UserId=$JELLYFIN_USERID"
[ -n "$ITEM_IDS" ] && URL_PARAMS="${URL_PARAMS}&Ids=$ITEM_IDS"

log_notice "Creating collection: $NAME"
[ -n "$ITEM_IDS" ] && log_debug "  Adding items: $ITEM_IDS"

jellyfin_request POST "/Collections$URL_PARAMS"

if jellyfin_success; then
    COLLECTION_ID=$(echo "$API_BODY" | jq -r '.Id')
    log_success "Collection created successfully"
    log_notice "  Collection ID: $COLLECTION_ID"
    echo "$COLLECTION_ID"
else
    log_error "Failed to create collection: $API_BODY"
    exit 1
fi
