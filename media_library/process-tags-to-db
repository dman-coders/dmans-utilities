#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/process_media.lib"

# Extract tags from media files and ensure they exist in the database.
#
# Given file(s) or directories, this script:
# - Extracts tags from EXIF metadata fields (Subject, Keywords, HierarchicalSubject, etc.)
# - Parses hierarchical tags (slash-separated paths)
# - Ensures all tags exist in the media database with proper parent-child relationships
# - Counts and reports on tags found
#
# This does NOT store file-to-tag associations yet - just builds the tag hierarchy.

processFile() {
    source "$SCRIPT_DIR/process_media.lib"
    local source_file="$1"

    if [[ ! -f "${source_file}" ]]; then
        log_error "Error: $source_file is not a file"
        return 1
    fi

    log_notice "Processing: $source_file"

    # Extract tags from EXIF metadata
    local tag_output
    if ! tag_output=$(extract_exif_tags "$source_file" 2>/dev/null); then
        log_debug "  No tags found in $source_file"
        return 0
    fi

    # Convert newline-separated output to array
    mapfile -t unique_tags < <(echo "$tag_output")

    if [[ ${#unique_tags[@]} -eq 0 ]]; then
        log_debug "  No tags found in $source_file"
        return 0
    fi

    log_notice "  Found ${#unique_tags[@]} unique tag(s)"
    log_notice "All tags: $(printf '"%s", ' "${unique_tags[@]}" | sed 's/, $//')"

    # Process each tag
    for tag in "${unique_tags[@]}"; do
      log_info "Adding tag '$tag' to the database"
      ensure_tag_exists "$tag"
    done
    return 0
}

# Export variables needed by subprocess
export processFile
export SCRIPT_DIR
export MEDIA_DB

# Process all files
parallelProcessFiles "$@"
#processFile "$@"

